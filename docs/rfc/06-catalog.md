# Section 6: Catalog System

## 6.1 Overview

mallardb uses a **minimal interception** philosophy for catalog emulation. DuckDB provides native `pg_catalog` and `information_schema` support that handles most PostgreSQL catalog queries directly. mallardb only intercepts queries that require PostgreSQL-specific emulation:

- Authentication-related queries (DuckDB has no auth system)
- Session/connection information
- Database-level metadata (different concept in DuckDB)
- PostgreSQL-specific functions not in DuckDB

## 6.2 Implementation Strategy

### 6.2.1 Minimal Interception Philosophy

Most catalog queries pass through directly to DuckDB's built-in `pg_catalog` tables:

| Catalog | Strategy |
|---------|----------|
| `pg_catalog.pg_type` | **Pass through** - DuckDB native |
| `pg_catalog.pg_class` | **Pass through** - DuckDB native |
| `pg_catalog.pg_namespace` | **Pass through** - DuckDB native |
| `pg_catalog.pg_attribute` | **Pass through** - DuckDB native |
| `pg_catalog.pg_proc` | **Pass through** - DuckDB native |
| `pg_catalog.pg_index` | **Pass through** - DuckDB native |
| `pg_catalog.pg_constraint` | **Pass through** - DuckDB native |
| `pg_catalog.pg_description` | **Pass through** - DuckDB native |
| `information_schema.*` | **Pass through** - DuckDB native |

### 6.2.2 Intercepted Queries

mallardb intercepts only PostgreSQL-specific queries that DuckDB cannot handle:

| Query Type | Reason |
|------------|--------|
| `version()`, `current_database()`, `current_schema()` | PostgreSQL-specific functions |
| `current_user`, `session_user` | Auth system (DuckDB has none) |
| `pg_backend_pid()` | Session information |
| `pg_roles`, `pg_user` | Auth-related catalogs |
| `pg_database` | Database concept differs in DuckDB |
| `pg_settings` | Server configuration |
| `pg_stat_activity` | Connection monitoring |
| `has_*_privilege()` functions | Permission checks (always return true) |
| `pg_encoding_to_char()` | Encoding function |
| `pg_get_userbyid()` | Auth-related function |
| `SHOW search_path` | Schema search path |

## 6.3 DuckDB Native pg_catalog Tables

DuckDB provides built-in `pg_catalog` tables that handle most PostgreSQL catalog queries. mallardb passes these through directly without modification:

- `pg_namespace` - Schema metadata
- `pg_class` - Table/view/index metadata
- `pg_attribute` - Column metadata
- `pg_type` - Type metadata
- `pg_constraint` - Constraint metadata
- `pg_index` - Index metadata
- `pg_proc` - Function metadata
- `pg_description` - Object descriptions

These tables follow PostgreSQL's column layout and provide compatibility with ORMs and database tools.

## 6.4 Synthesized Catalog Responses

The following catalogs require mallardb-specific synthesis because they involve authentication, sessions, or database-level concepts that DuckDB doesn't track:

### 6.4.1 pg_roles / pg_user

Returns the current authenticated user with superuser privileges:

| Column | Value |
|--------|-------|
| rolname | Current authenticated username |
| rolsuper | true |
| rolcanlogin | true |
| rolconnlimit | -1 |

### 6.4.2 pg_database

Returns the configured database name (single database):

| Column | Value |
|--------|-------|
| datname | Configured database name |
| encoding | 6 (UTF8) |
| datallowconn | true |
| datconnlimit | -1 |

### 6.4.3 pg_settings

Returns basic server configuration:

| Setting | Value |
|---------|-------|
| server_version | Configured PG version (default: 15.0) |
| server_encoding | UTF8 |
| client_encoding | UTF8 |
| DateStyle | ISO, MDY |
| TimeZone | UTC |
| integer_datetimes | on |
| standard_conforming_strings | on |

### 6.4.4 pg_stat_activity

Returns current connection information:

| Column | Value |
|--------|-------|
| datname | Current database |
| pid | Process ID |
| usename | Current user |
| state | "active" |

## 6.5 information_schema Views

DuckDB provides native `information_schema` support. These queries pass through directly to DuckDB without modification.

## 6.6 psql Command Support

mallardb MUST support catalog queries generated by these psql commands:

| Command | Description | Key Catalogs |
|---------|-------------|--------------|
| `\dt` | List tables | pg_class, pg_namespace |
| `\dt+` | List tables with size | pg_class, pg_namespace, pg_total_relation_size |
| `\d tablename` | Describe table | pg_attribute, pg_type, pg_constraint, pg_index |
| `\dn` | List schemas | pg_namespace |
| `\du` | List roles | pg_roles |
| `\df` | List functions | pg_proc (minimal) |
| `\di` | List indexes | pg_index, pg_class |
| `\dv` | List views | pg_class (relkind='v') |
| `\l` | List databases | pg_database |
| `\conninfo` | Connection info | Session state |

### 6.6.1 Size Functions

Size functions (`pg_total_relation_size`, `pg_table_size`, `pg_indexes_size`, `pg_size_pretty`) pass through to DuckDB's native implementations.

## 6.7 ORM Compatibility

### 6.7.1 SQLAlchemy

SQLAlchemy introspection queries:

```sql
-- Table existence
SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = $1);

-- Column introspection  
SELECT * FROM information_schema.columns WHERE table_name = $1;

-- Primary keys
SELECT a.attname FROM pg_index i
JOIN pg_attribute a ON a.attrelid = i.indrelid AND a.attnum = ANY(i.indkey)
WHERE i.indrelid = $1::regclass AND i.indisprimary;

-- Foreign keys
SELECT ... FROM pg_constraint WHERE contype = 'f' AND conrelid = $1::regclass;
```

### 6.7.2 Prisma

Prisma introspection queries include:

```sql
-- Database version
SELECT version();

-- Schema list
SELECT nspname FROM pg_namespace WHERE nspname NOT LIKE 'pg_%';

-- Enum types
SELECT t.typname, e.enumlabel FROM pg_type t 
JOIN pg_enum e ON t.oid = e.enumtypid;
```

### 6.7.3 TypeORM

TypeORM introspection patterns similar to SQLAlchemy.

## 6.8 System Functions

mallardb MUST implement these PostgreSQL system functions:

| Function | Return | Implementation |
|----------|--------|----------------|
| `current_database()` | name | Return configured database name |
| `current_schema()` | name | Return 'main' (DuckDB's default schema) |
| `current_user` | name | Return authenticated username |
| `session_user` | name | Return authenticated username |
| `version()` | text | Return mallardb version string |
| `pg_backend_pid()` | int | Return connection's process ID |
| `pg_typeof(any)` | regtype | Return type name of argument |
| `has_table_privilege(...)` | bool | Return TRUE (permissive) |
| `has_schema_privilege(...)` | bool | Return TRUE (permissive) |

### 6.8.1 version() Format

The `version()` function MUST return a string parseable by PostgreSQL clients:

```
PostgreSQL 15.0 (mallardb 0.1.0, DuckDB 1.0.0)
```

Format: `PostgreSQL {compat_version} (mallardb {version}, DuckDB {duckdb_version})`

## 6.9 Search Path

The `search_path` is reported as `main` (DuckDB's default schema) via `SHOW search_path`. DuckDB uses `main` as its default schema rather than PostgreSQL's `public`.

```sql
SHOW search_path;  -- Returns 'main'
```

Note: DuckDB's schema system differs from PostgreSQL. The SQL rewriter automatically translates `'public'` schema references to `'main'` for compatibility.
